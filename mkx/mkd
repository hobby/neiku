#!/bin/bash
# vim:ts=4:sw=4:expandtab

############################################################
# NAME
#     mkd - a toy for make and deploy targets.
#
# SYNOPSIS
#     mkd
#     mkd [ -f makefile ] [ -C directory ] [ targets ] ...
# 
#     debug=on mkd ...
#
# AUTHORS
#     neiku project <ku7d@qq.com> 
#
# SEE ALSO
#     mkxrc_targets
#     mkxrc_modules
#     mkxrc_configs
#
# VERSION
#     2015/11/21: 支持命令行或者makefile中OUTPUT定义的target
#                 支持-f选项指定自定义makefile
#                 支持-C选项指定自定义make目录
#     2015/11/22: 支持绝对/相对目录递归mkd
#     2015/11/25: 支持部署路径跟着target配置走，独立于module
#                 支持可配置登录方式(目前只支持rsa)
#                 支持自定义make前/后执行命令(pre/post-make)
#                 支持deploy前/后执行命令(pre/post-deploy)
#     2015/11/26: 支持忽略未配置target
#     2015/11/28: 支持使用mkm查找target(project/global/system级别)
#                 支持使用mkm查找module(project/global/system级别)
#                 支持使用mkm查找config(project/global/system级别)
#
############################################################

# target(*) <-----> module(1) <-----> deploy destination(1)

# get make directory
makedir="`make $* -n -p 2>/dev/null | grep '^CURDIR :=' | tail -n1 | cut -c11-`"
if [ -z "$makedir" ] ; then
    mklog error "make directory not found, make args:[$*]"
    exit 1
fi
mklog debug "makedir=$makedir"

# maybe mkd for sub directorys
submakedirs="`make $* -n -p 2>/dev/null | grep '^DIRS =' | tail -n1 | cut -c8-`"
mklog debug "submakedirs=$submakedirs"
if [ -n "$submakedirs" ] ; then
    for subdir in $submakedirs
    do
        if [ "${subdir:0:1}" = "/" ] ; then
            mkd -C $subdir
        else
            mkd -C $makedir/$subdir
        fi
    done
    mklog debug "mkd for directorys end"
    exit 0
fi

# get targets from cmdline
targets="`make $* -n -p 2>/dev/null | grep '^MAKECMDGOALS :=' | cut -c17-`"
if [ -z "$targets" ] ; then
    # default targets from OUTPUT var in makefile
    targets="`make $* -n -p 2>/dev/null | grep '^OUTPUT =' | cut -c10-`"
fi
if [ -z "$targets" ] ; then
    mklog error "targets not found, make args:[$*]"
    exit 1
fi
mklog debug "targets=$targets"

# pre make
cmd="`mkm get config pre-make`"
mklog debug "pre-make:[$cmd]"
pwd="`pwd`"
cd "$makedir" && eval "$cmd"
cd "$pwd"

# make targets
make $* $targets
if [ $? -ne 0 ] ; then
    mklog error "make fail, make args:[$* $targets]"
    exit 1
fi

# post make
cmd="`mkm get config post-make`"
mklog debug "pre-make:[$cmd]"
pwd="`pwd`"
cd "$makedir" && eval "$cmd"
cd "$pwd"

# deploy targets
for target in $targets
do
    # .so target is specail
    if expr match "$target" ".*\.so$" >/dev/null 2>&1 ; then
        if ! expr match "$target" "^lib" >/dev/null 2>&1 ; then
            target="lib$target"
        fi
    fi
    # .a target is specail
    if expr match "$target" ".*\.a$" >/dev/null 2>&1 ; then
        if ! expr match "$target" "^lib" >/dev/null 2>&1 ; then
            target="lib$target"
        fi
    fi

    # find target's module
    module=""; hostpath="";
    eval `mkm find target $target \
          | awk '{printf "module=%s; hostpath=%s;" \
                         ,       $1,          $2}'`
    if [ -z "$module" ] ; then
        mklog error "module not found, target:[$target]"
        continue
    fi 

    # find module's info
    mtype=""; username=""; rsapkey=""; hostname=""; hostport="";
    eval `mkm find module $module \
          | awk '{printf "mtype=%s; username=%s; rsapkey=%s; hostname=%s; hostport=%s;" \
                         ,     $2,          $3,         $4,          $5,          $6}'`
    mklog debug "target:[$target], module:[$module], mtype:[$mtype]," \
                "username:[$username], rsa-private:[$rsapkey]," \
                "hostname:[$hostname], hostport:[$hostport]," \
                "hostpath:[$hostpath], makedir:[$makedir]"
    if [   -z "$mtype" -o -z "$username" -o -z "$rsapkey" \
        -o -z "$hostname" -o -z "$hostport" -o -z "$hostpath" ]
    then
        mklog error "module not found, target:[$target], module:[$module]"
        exit 1
    fi

    # do deploy
    mkrun pre-deploy $target
    if [ "$mtype" = "rsa" ] ; then
        scp -C -i $rsapkey -P $hostport "$makedir/$target" $username@$hostname:$hostpath
    else
        mklog error "found unsupported mtype, mtype:[$mtype]"
        exit 1
    fi
    mkrun post-deploy $target
done
